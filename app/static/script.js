var markers = [];
var map;

function init_map() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 37.7904574, lng: -122.3890122}, // center at San Francisco
        zoom: 10
    });

};

// adds a marker to the map
function add_marker(info){
    var marker = new google.maps.Marker({
        position: new google.maps.LatLng(info.lat, info.lng),
        map: map,
        title: info.title
    });   
    markers.push(marker);

    var infowindow = new google.maps.InfoWindow({
        content : build_content(info),
        maxWidth: 300,
    });

    google.maps.event.addListener(marker, 'click', function() {
        infowindow.open(map, marker);
    });
};

// removes the markers from the map
function clear_markers() {
    for(var i = 0; i < markers.length; i++) { 
        markers[i].setMap(null);
    }
}

// builds content windoews - shows when a marker is clicked
function build_content(info) {
    return  '<div id="content">' +
                '<h1>' + info.title + '</h1>' +
                '<ul>' +
                    '<li><b>location: </b>' + info.location + '</li>' +
                    '<li><b>director: </b>' + info.director + '</li>' +
                '</ul>' +
                '<p>' + info.fact + '</p>'
            '</div>';
}

// jquery functions
$(function() {
    // auto completion
    $( "#movie-title" ).autocomplete({
        // If set to true the first item will automatically be focused when the menu is shown
        autoFocus: true,
        // trigger autocomplete after x characters
        minLength: 1, 
        // Defines the data to use, must be specified as: array, string or function
        source: function( request, response ) {
            
            $.getJSON( $SCRIPT_ROOT + "/search_title", 
                    // data into flask  
                    { title: request.term, }, 
                    // process result from jsonify in flask (callback function)
                    function(data) {
                        var movies = {};
                        $.map(data.results, function(movie_obj) {
                            var title = movie_obj.title;
                            // create info object
                            var info = {title: movie_obj.title,
                                        director: movie_obj.director,
                                        location: movie_obj.location,
                                        fact: movie_obj.fact,
                                        lat: movie_obj.lat, 
                                        lng: movie_obj.lng};
            
                            movies[title] = movies[title] || [];
                            movies[title].push(info);
                        }); // end of map
                        response($.map(movies, function (data, title) {
                            return {
                                label: title,
                                data: data,
                            }
                        }));
                    } // end of callback function
            ); // end of getJSON
        },
        // Triggered when an item is selected from the menu
        select: function (event, ui) {
            event.preventDefault();
            // clear and set markers
            clear_markers();
            var label = ui.item.label;
            var data = ui.item.data;
            data.forEach(function(info) {
                add_marker(info);
            });
            $("#movie-title").val(label);
        },
        // remove autogenerated text messages
        messages: {
            noResults: '',
            results: function() {}
        }
    });
    // clear button - clear the markers from the map and resets the search field
    $("#clear").click(function(){
        clear_markers();
        $("#movie-title").val('');
    });
});

google.maps.event.addDomListener(window, 'load', init_map);